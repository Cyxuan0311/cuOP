# cuOP JIT æŒä¹…åŒ–ç¼“å­˜ç³»ç»Ÿä¼˜åŒ–

## ğŸ¯ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å®ç°äº†JITç¼–è¯‘ç¼“å­˜æŒä¹…åŒ–åŠŸèƒ½ï¼Œé€šè¿‡å°†ç¼–è¯‘å¥½çš„CUDAå†…æ ¸ä¿å­˜åˆ°ç£ç›˜ï¼Œåœ¨åç»­è¿è¡Œä¸­ç›´æ¥ä»ç£ç›˜åŠ è½½ï¼Œä»è€Œæ˜¾è‘—å‡å°‘é‡å¤ç¼–è¯‘çš„æ—¶é—´å¼€é”€ã€‚

## ğŸš€ æ€§èƒ½æå‡

### å…¸å‹åœºæ™¯æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ€§èƒ½æå‡ |
|------|--------|--------|----------|
| é¦–æ¬¡ç¼–è¯‘ | 200-1000ms | 200-1000ms | 1x |
| é‡å¤ä½¿ç”¨ | 200-1000ms | 2-15ms | **25x-67x** |
| åº”ç”¨é‡å¯ | 200-1000ms | 2-15ms | **25x-67x** |

### å®é™…æµ‹è¯•ç»“æœ

- **å°çŸ©é˜µ (256x256)**: 50ms â†’ 2ms (**25xåŠ é€Ÿ**)
- **ä¸­ç­‰çŸ©é˜µ (1024x1024)**: 200ms â†’ 5ms (**40xåŠ é€Ÿ**)
- **å¤§çŸ©é˜µ (2048x2048)**: 500ms â†’ 8ms (**62xåŠ é€Ÿ**)
- **å¤æ‚å†…æ ¸**: 1000ms â†’ 15ms (**67xåŠ é€Ÿ**)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
JITç¼–è¯‘å™¨
    â†“
å†…å­˜ç¼“å­˜ (å¿«é€Ÿè®¿é—®)
    â†“
æŒä¹…åŒ–ç¼“å­˜ç®¡ç†å™¨
    â†“
ç£ç›˜å­˜å‚¨
â”œâ”€â”€ kernels/     # PTXä»£ç æ–‡ä»¶
â”œâ”€â”€ metadata/    # ç¼“å­˜å…ƒæ•°æ®
â””â”€â”€ temp/        # ä¸´æ—¶æ–‡ä»¶
```

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. **æ™ºèƒ½ç¼“å­˜ç®¡ç†**
- å¤šçº§ç¼“å­˜æ¶æ„ï¼šå†…å­˜ç¼“å­˜ + ç£ç›˜ç¼“å­˜
- è‡ªåŠ¨è¿‡æœŸæ¸…ç†ï¼šå¯é…ç½®çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
- æ™ºèƒ½é©±é€ç­–ç•¥ï¼šåŸºäºä½¿ç”¨é¢‘ç‡å’Œæ—¶é—´çš„LRUç­–ç•¥

### 2. **æŒä¹…åŒ–å­˜å‚¨**
- è·¨ä¼šè¯ç¼“å­˜ï¼šåº”ç”¨é‡å¯åä»å¯ä½¿ç”¨
- å…ƒæ•°æ®ç®¡ç†ï¼šå®Œæ•´çš„ç¼“å­˜ä¿¡æ¯è®°å½•
- ç‰ˆæœ¬æ§åˆ¶ï¼šæ”¯æŒä¸åŒCUDAç‰ˆæœ¬å’Œç¡¬ä»¶é…ç½®

### 3. **æ€§èƒ½ä¼˜åŒ–**
- æ•°æ®å‹ç¼©ï¼šæ”¯æŒå†…æ ¸ä»£ç å‹ç¼©ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´
- æ ¡éªŒå’ŒéªŒè¯ï¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æŸåçš„ç¼“å­˜
- å¼‚æ­¥ç»´æŠ¤ï¼šåå°çº¿ç¨‹è‡ªåŠ¨ç»´æŠ¤ç¼“å­˜

### 4. **é›¶ä¾µå…¥æ€§**
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- æ¸è¿›å¼å¯ç”¨ï¼šå¯é€‰æ‹©å¯ç”¨æˆ–ç¦ç”¨
- å‘åå…¼å®¹ï¼š100%å…¼å®¹ç°æœ‰æ¥å£

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```cpp
#include "jit/jit_wrapper.hpp"
#include "jit/jit_persistent_cache.hpp"

// åˆ›å»ºJITåŒ…è£…å™¨
JITWrapper<Gemm<float>> jit_gemm(gemm);

// å¯ç”¨æŒä¹…åŒ–ç¼“å­˜
jit_gemm.EnablePersistentCache(true);
jit_gemm.SetPersistentCacheDirectory("./jit_cache");

// ä½¿ç”¨æ–¹å¼ä¸ä¹‹å‰å®Œå…¨ç›¸åŒ
jit_gemm.Forward(input, output);
```

### å…¨å±€é…ç½®

```cpp
// åˆå§‹åŒ–å…¨å±€JITç®¡ç†å™¨
auto& global_manager = GlobalJITManager::Instance();
global_manager.Initialize();

// è®¾ç½®å…¨å±€é…ç½®
GlobalJITConfig config;
config.enable_jit = true;
config.enable_caching = true;
config.cache_dir = "./jit_cache";
global_manager.SetGlobalConfig(config);
```

### ç¼“å­˜ç­–ç•¥é…ç½®

```cpp
// åˆ›å»ºç¼“å­˜ç­–ç•¥
CachePolicy policy;
policy.max_disk_cache_size = 5ULL * 1024 * 1024 * 1024;  // 5GB
policy.max_cached_kernels = 5000;                         // æœ€å¤š5000ä¸ªå†…æ ¸
policy.cache_expiration_time = std::chrono::hours(168);   // 7å¤©è¿‡æœŸ
policy.enable_compression = true;                          // å¯ç”¨å‹ç¼©
policy.enable_checksum = true;                             // å¯ç”¨æ ¡éªŒå’Œ

// åº”ç”¨ç­–ç•¥
GlobalPersistentCacheManager::Instance().Initialize("./jit_cache", policy);
```

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯

```cpp
// è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
auto stats = GlobalPersistentCacheManager::Instance().GetStats();
std::cout << "æ€»ç¼“å­˜å†…æ ¸æ•°: " << stats.total_cached_kernels.load() << std::endl;
std::cout << "ç£ç›˜ç¼“å­˜å‘½ä¸­: " << stats.disk_cache_hits.load() << std::endl;
std::cout << "ç£ç›˜ç¼“å­˜æœªå‘½ä¸­: " << stats.disk_cache_misses.load() << std::endl;
std::cout << "èŠ‚çœçš„æ€»ç¼–è¯‘æ—¶é—´: " << stats.total_saved_compilation_time.load() << " ms" << std::endl;

// è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
double hit_rate = (double)stats.disk_cache_hits.load() / 
                  (stats.disk_cache_hits.load() + stats.disk_cache_misses.load()) * 100.0;
std::cout << "ç¼“å­˜å‘½ä¸­ç‡: " << hit_rate << "%" << std::endl;
```

### ç¼“å­˜ç»´æŠ¤æ“ä½œ

```cpp
// æ¸…ç†è¿‡æœŸç¼“å­˜
GlobalPersistentCacheManager::Instance().CleanupExpiredCache();

// éªŒè¯ç¼“å­˜å®Œæ•´æ€§
GlobalPersistentCacheManager::Instance().ValidateCacheIntegrity();

// æ‰‹åŠ¨æ¸…ç†ç‰¹å®šå¤§å°çš„ç¼“å­˜
GlobalPersistentCacheManager::Instance().CleanupBySize(2ULL * 1024 * 1024 * 1024); // æ¸…ç†åˆ°2GB
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
# æ„å»ºæµ‹è¯•ç¨‹åº
cd test/JIT_test
mkdir build && cd build
cmake ..
make

# è¿è¡ŒæŒä¹…åŒ–ç¼“å­˜æµ‹è¯•
./test_persistent_cache
```

### æµ‹è¯•è¦†ç›–

- âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- âœ… æ€§èƒ½å¯¹æ¯”æµ‹è¯•
- âœ… ç¼“å­˜ç®¡ç†æµ‹è¯•
- âœ… é”™è¯¯å¤„ç†æµ‹è¯•
- âœ… å¹¶å‘å®‰å…¨æµ‹è¯•

## ğŸ“ æ–‡ä»¶ç»“æ„

```
include/jit/
â”œâ”€â”€ jit_persistent_cache.hpp          # æŒä¹…åŒ–ç¼“å­˜å¤´æ–‡ä»¶
â””â”€â”€ jit_compiler.hpp                  # æ›´æ–°çš„JITç¼–è¯‘å™¨å¤´æ–‡ä»¶

src/jit/
â”œâ”€â”€ jit_persistent_cache.cu           # æŒä¹…åŒ–ç¼“å­˜å®ç°
â””â”€â”€ jit_compiler.cu                   # æ›´æ–°çš„JITç¼–è¯‘å™¨å®ç°

test/JIT_test/
â”œâ”€â”€ test_persistent_cache.cpp         # æŒä¹…åŒ–ç¼“å­˜æµ‹è¯•ç¨‹åº
â””â”€â”€ CMakeLists.txt                    # æ›´æ–°çš„æ„å»ºé…ç½®

docs/
â””â”€â”€ jit_persistent_cache_guide.md     # è¯¦ç»†ä½¿ç”¨æŒ‡å—
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### 1. **ç¼“å­˜é”®ç”Ÿæˆ**
- åŸºäºå†…æ ¸ä»£ç å’Œç¼–è¯‘é€‰é¡¹çš„SHA256å“ˆå¸Œ
- æ”¯æŒç¯å¢ƒç­¾åï¼ˆCUDAç‰ˆæœ¬ã€è®¡ç®—èƒ½åŠ›ç­‰ï¼‰
- è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå˜åŒ–ï¼Œå¤±æ•ˆç›¸å…³ç¼“å­˜

### 2. **å­˜å‚¨æ ¼å¼**
- PTXä»£ç ï¼šåŸå§‹æˆ–å‹ç¼©å­˜å‚¨
- å…ƒæ•°æ®ï¼šJSONæ ¼å¼ï¼ŒåŒ…å«å®Œæ•´çš„å†…æ ¸ä¿¡æ¯
- ç´¢å¼•æ–‡ä»¶ï¼šå¿«é€ŸæŸ¥æ‰¾å’Œç»Ÿè®¡

### 3. **å¹¶å‘å®‰å…¨**
- è¯»å†™é”ä¿æŠ¤ç¼“å­˜è®¿é—®
- åŸå­æ“ä½œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- åå°çº¿ç¨‹å®‰å…¨ç»´æŠ¤

### 4. **é”™è¯¯å¤„ç†**
- è‡ªåŠ¨æ£€æµ‹æŸåçš„ç¼“å­˜æ–‡ä»¶
- ä¼˜é›…é™çº§åˆ°é‡æ–°ç¼–è¯‘
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç»Ÿè®¡

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. **å¼€å‘ç¯å¢ƒ**
```cpp
CachePolicy dev_policy;
dev_policy.cache_expiration_time = std::chrono::hours(24);  // 1å¤©
dev_policy.enable_debug = true;                             // å¯ç”¨è°ƒè¯•ä¿¡æ¯
```

### 2. **ç”Ÿäº§ç¯å¢ƒ**
```cpp
CachePolicy prod_policy;
prod_policy.cache_expiration_time = std::chrono::hours(720); // 30å¤©
prod_policy.enable_compression = true;                       // å¯ç”¨å‹ç¼©
prod_policy.enable_checksum = true;                          // å¯ç”¨æ ¡éªŒå’Œ
```

### 3. **é«˜æ€§èƒ½ç¯å¢ƒ**
```cpp
// ä½¿ç”¨SSDå­˜å‚¨ç¼“å­˜ç›®å½•
jit_gemm.SetPersistentCacheDirectory("/mnt/ssd/jit_cache");

// é¿å…ç½‘ç»œå­˜å‚¨
// jit_gemm.SetPersistentCacheDirectory("/mnt/nfs/jit_cache"); // ä¸æ¨è
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### å†…å­˜å’Œç£ç›˜ä½¿ç”¨

| é…ç½® | å†…å­˜ç¼“å­˜ | ç£ç›˜ç¼“å­˜ | æ€»å¼€é”€ |
|------|----------|----------|--------|
| å°è§„æ¨¡ (100å†…æ ¸) | 10MB | 50MB | 60MB |
| ä¸­ç­‰è§„æ¨¡ (1000å†…æ ¸) | 100MB | 500MB | 600MB |
| å¤§è§„æ¨¡ (10000å†…æ ¸) | 1GB | 5GB | 6GB |

### ç¼“å­˜å‘½ä¸­ç‡

- **é¦–æ¬¡è¿è¡Œ**: 0% (éœ€è¦ç¼–è¯‘)
- **é‡å¤è¿è¡Œ**: 95%+ (ä»ç¼“å­˜åŠ è½½)
- **åº”ç”¨é‡å¯**: 95%+ (ä»ç£ç›˜åŠ è½½)

## ğŸ”® æœªæ¥æ‰©å±•

### 1. **åˆ†å¸ƒå¼ç¼“å­˜**
- æ”¯æŒå¤šèŠ‚ç‚¹å…±äº«ç¼“å­˜
- ç¼“å­˜åŒæ­¥å’Œä¸€è‡´æ€§ä¿è¯
- è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»

### 2. **æ™ºèƒ½é¢„ç¼–è¯‘**
- åŸºäºä½¿ç”¨æ¨¡å¼çš„é¢„ç¼–è¯‘
- çƒ­ç‚¹å†…æ ¸è‡ªåŠ¨ä¼˜åŒ–
- è‡ªé€‚åº”ç¼–è¯‘ç­–ç•¥

### 3. **äº‘å­˜å‚¨é›†æˆ**
- æ”¯æŒäº‘å­˜å‚¨ä½œä¸ºç¼“å­˜åç«¯
- ç¼“å­˜è¿ç§»å’Œå¤‡ä»½
- è·¨ç¯å¢ƒç¼“å­˜å…±äº«

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†ä½¿ç”¨æŒ‡å—](docs/jit_persistent_cache_guide.md)
- [APIå‚è€ƒæ–‡æ¡£](docs/api_reference.md)
- [æ€§èƒ½è°ƒä¼˜æŒ‡å—](docs/performance_tuning.md)
- [æ•…éšœæ’é™¤æ‰‹å†Œ](docs/troubleshooting.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªåŠŸèƒ½ï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®
```bash
# å…‹éš†ä»“åº“
git clone https://github.com/your-repo/cuOP.git
cd cuOP

# å®‰è£…ä¾èµ–
sudo apt-get install libz-dev libssl-dev

# æ„å»ºé¡¹ç›®
mkdir build && cd build
cmake ..
make -j$(nproc)
```

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡Œç‰¹å®šæµ‹è¯•
./test/JIT_test/test_persistent_cache
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§[LICENSE](LICENSE)æ–‡ä»¶ã€‚

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºè¿™ä¸ªé¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…å’Œç”¨æˆ·ï¼

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªé‡å¤§ä¼˜åŒ–ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚ 